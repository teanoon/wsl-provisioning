---
- name: Install dependencies
  hosts: localhost
  tasks:
    - name: use custom apt file
      copy:
        dest: /etc/apt/sources.list
        content: |
          deb http://mirrors.aliyun.com/ubuntu/ focal main restricted universe multiverse
          deb-src http://mirrors.aliyun.com/ubuntu/ focal main restricted universe multiverse

          deb http://mirrors.aliyun.com/ubuntu/ focal-security main restricted universe multiverse
          deb-src http://mirrors.aliyun.com/ubuntu/ focal-security main restricted universe multiverse

          deb http://mirrors.aliyun.com/ubuntu/ focal-updates main restricted universe multiverse
          deb-src http://mirrors.aliyun.com/ubuntu/ focal-updates main restricted universe multiverse

          deb http://mirrors.aliyun.com/ubuntu/ focal-proposed main restricted universe multiverse
          deb-src http://mirrors.aliyun.com/ubuntu/ focal-proposed main restricted universe multiverse

          deb http://mirrors.aliyun.com/ubuntu/ focal-backports main restricted universe multiverse
          deb-src http://mirrors.aliyun.com/ubuntu/ focal-backports main restricted universe multiverse
    - name: update
      apt:
        update_cache: true
        cache_valid_time: 3600
        force_apt_get: true
        upgrade: 'yes'
    - name: install
      apt:
        package:
          - tmux
          - htop
          - zsh
          - openvpn
          - privoxy
          - trojan
          - dnsmasq
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg-agent
          - software-properties-common
- name: user dev
  hosts: localhost
  tasks:
    - name: chsh
      command: chsh -s /usr/bin/zsh
    - name: sudo password-less
      copy:
        dest: /etc/sudoers.d/dev
        content: |
          %dev ALL=(ALL:ALL) NOPASSWD:ALL
- name: Setup systemctl
  hosts: localhost
  tasks:
    - name: get systemctl
      become: yes
      become_user: dev
      git:
        repo: https://github.com/DamionGans/ubuntu-wsl2-systemd-script.git
        dest: ~/.ubuntu-wsl2-systemd-script
    - name: start with systemctl
      blockinfile:
        path: /etc/zsh/zshenv
        insertafter: EOF
        content: |
          # Start or enter a PID namespace in WSL2
          if [[ $0 == -* ]]
          then
              source /usr/sbin/start-systemd-namespace
          fi
- name: zsh setup
  hosts: localhost
  remote_user: dev
  tasks:
    - name: get oh-my-zsh
      git:
        repo: https://github.com/ohmyzsh/ohmyzsh.git
        dest: ~/.ohmyzsh
    - name: install zsh-syntax-highlighting
      git:
        repo: https://github.com/zsh-users/zsh-syntax-highlighting.git
        dest: ~/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting
    - name: install zsh-completions
      git:
        repo: https://github.com/zsh-users/zsh-completions.git
        dest: ~/.oh-my-zsh/custom/plugins/zsh-completions
    - name: install zsh-autosuggestions
      git:
        repo: https://github.com/zsh-users/zsh-autosuggestions.git
        dest: ~/.oh-my-zsh/custom/plugins/zsh-autosuggestions
